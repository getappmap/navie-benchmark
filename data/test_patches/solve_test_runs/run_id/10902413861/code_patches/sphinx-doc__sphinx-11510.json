{
  "instance_id": "sphinx-doc__sphinx-11510",
  "edit_test_file": "tests/test_application.py",
  "code_patch": "diff --git a/sphinx/directives/other.py b/sphinx/directives/other.py\nindex 19f7c0a..c7324b6 100644\n--- a/sphinx/directives/other.py\n+++ b/sphinx/directives/other.py\n@@ -376,6 +376,11 @@ class Include(BaseInclude, SphinxDirective):\n         rel_filename, filename = self.env.relfn2path(self.arguments[0])\n         self.arguments[0] = filename\n         self.env.note_included(filename)\n+\n+        # Re-emit the \"source-read\" event for included files\n+        content = self.state.document.settings.env.read_source(self.env)\n+        self.state.document.settings.env.events.emit('source-read', self.env.docname, [content])\n+\n         return super().run()\n \n \n\ndiff --git a/sphinx/io.py b/sphinx/io.py\nindex 4874fdf..46cede3 100644\n--- a/sphinx/io.py\n+++ b/sphinx/io.py\n@@ -112,6 +112,9 @@ class SphinxStandaloneReader(SphinxBaseReader):\n         # emit \"source-read\" event\n         arg = [content]\n         env.events.emit('source-read', env.docname, arg)\n+\n+        # Ensure modifications are applied to the source\n+        self.source = Input(arg[0], source_path=self.source.source_path)\n         return arg[0]\n \n \n",
  "test_patch": "diff --git a/tests/test_ext_source_read_include_files.py b/tests/test_ext_source_read_include_files.py\nnew file mode 100644\nindex 0000000..0e1bf1a\n--- /dev/null\n+++ b/tests/test_ext_source_read_include_files.py\n@@ -0,0 +1,78 @@\n+import os\n+import shutil\n+from sphinx.testing.util import SphinxTestApp\n+from io import StringIO\n+from pathlib import Path\n+import unittest\n+\n+class TestSourceReadIncludeFiles(unittest.TestCase):\n+    def setUp(self):\n+        # Setup directories and files\n+        self.srcdir = Path('test_source_read_include')\n+        self.srcdir.mkdir(exist_ok=True)\n+        (self.srcdir / 'conf.py').write_text(\"\"\"\n+import sys\n+import os\n+\n+sys.path.insert(0, os.path.abspath('.'))\n+\n+extensions = [\n+    'my_extension'\n+]\n+\"\"\", encoding='utf8')\n+\n+        (self.srcdir / 'index.rst').write_text(\"\"\"\n+This is a test\n+==============\n+\n+.. include:: something-to-include.rst\n+\n+&REPLACE_ME;\n+\"\"\", encoding='utf8')\n+\n+        (self.srcdir / 'something-to-include.rst').write_text(\"\"\"\n+Testing\n+=======\n+\n+&REPLACE_ME;\n+\"\"\", encoding='utf8')\n+\n+        (self.srcdir / 'my_extension.py').write_text(\"\"\"\n+from sphinx.application import Sphinx\n+\n+__version__ = '1.0'\n+\n+def subst_vars_replace(app: Sphinx, docname, source):\n+    result = source[0]\n+    result = result.replace(\"&REPLACE_ME;\", \"REPLACED\")\n+    source[0] = result\n+\n+def setup(app: Sphinx):\n+    app.connect('source-read', subst_vars_replace)\n+    return dict(\n+        version=__version__,\n+        parallel_read_safe=True,\n+        parallel_write_safe=True\n+    )\n+\"\"\", encoding='utf8')\n+\n+    def tearDown(self):\n+        # Clean up the directory after test\n+        shutil.rmtree(self.srcdir)\n+\n+    def test_source_read_include_files(self):\n+        # Create a Sphinx test app\n+        app = SphinxTestApp(srcdir=self.srcdir, status=StringIO(), warning=StringIO())\n+        app.build()\n+\n+        # Read the output HTML\n+        output_html = (app.outdir / 'index.html').read_text(encoding='utf8')\n+\n+        # Check for the incorrect output\n+        self.assertIn('&amp;REPLACE_ME;', output_html)\n+        self.assertIn('REPLACED', output_html)\n+\n+        app.cleanup()\n+\n+if __name__ == '__main__':\n+    unittest.main()\n\\ No newline at end of file\n",
  "test_inverted_patch": "diff --git a/tests/test_ext_source_read_include_files_inverted.py b/tests/test_ext_source_read_include_files_inverted.py\nnew file mode 100644\nindex 0000000..0539cd2\n--- /dev/null\n+++ b/tests/test_ext_source_read_include_files_inverted.py\n@@ -0,0 +1,79 @@\n+import os\n+import shutil\n+from sphinx.testing.util import SphinxTestApp\n+from io import StringIO\n+from pathlib import Path\n+import unittest\n+\n+class TestSourceReadIncludeFiles(unittest.TestCase):\n+    def setUp(self):\n+        # Setup directories and files\n+        self.srcdir = Path('test_source_read_include')\n+        self.srcdir.mkdir(exist_ok=True)\n+        (self.srcdir / 'conf.py').write_text(\"\"\"\n+import sys\n+import os\n+\n+sys.path.insert(0, os.path.abspath('.'))\n+\n+extensions = [\n+    'my_extension'\n+]\n+\"\"\", encoding='utf8')\n+\n+        (self.srcdir / 'index.rst').write_text(\"\"\"\n+This is a test\n+==============\n+\n+.. include:: something-to-include.rst\n+\n+&REPLACE_ME;\n+\"\"\", encoding='utf8')\n+\n+        (self.srcdir / 'something-to-include.rst').write_text(\"\"\"\n+Testing\n+=======\n+\n+&REPLACE_ME;\n+\"\"\", encoding='utf8')\n+\n+        (self.srcdir / 'my_extension.py').write_text(\"\"\"\n+from sphinx.application import Sphinx\n+\n+__version__ = '1.0'\n+\n+def subst_vars_replace(app: Sphinx, docname, source):\n+    result = source[0]\n+    result = result.replace(\"&REPLACE_ME;\", \"REPLACED\")\n+    source[0] = result\n+\n+def setup(app: Sphinx):\n+    app.connect('source-read', subst_vars_replace)\n+    return dict(\n+        version=__version__,\n+        parallel_read_safe=True,\n+        parallel_write_safe=True\n+    )\n+\"\"\", encoding='utf8')\n+\n+    def tearDown(self):\n+        # Clean up the directory after test\n+        shutil.rmtree(self.srcdir)\n+\n+    def test_source_read_include_files(self):\n+        # Create a Sphinx test app\n+        app = SphinxTestApp(srcdir=self.srcdir, status=StringIO(), warning=StringIO())\n+        app.build()\n+\n+        # Read the output HTML\n+        output_html = (app.outdir / 'index.html').read_text(encoding='utf8')\n+\n+        # Check for the incorrect output\n+        if '&amp;REPLACE_ME;' in output_html:\n+            raise AssertionError(\"__BUG__HERE__\")\n+        self.assertIn('REPLACED', output_html)\n+\n+        app.cleanup()\n+\n+if __name__ == '__main__':\n+    unittest.main()\n\\ No newline at end of file\n",
  "num_sent_chars": 1477940,
  "num_received_chars": 48085,
  "elapsed_time": 491.30187249183655,
  "lint_repair_count": 0,
  "test_generation_attempts": 4,
  "code_generation_attempts": 9,
  "pass_to_pass": true,
  "pass_to_fail": true,
  "fail_to_pass": false,
  "code_patch_score": 2,
  "appmap_data_test_status": null,
  "appmap_data_file_count": null,
  "appmap_data_context_size": null
}