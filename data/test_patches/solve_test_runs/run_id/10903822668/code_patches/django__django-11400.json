{
  "instance_id": "django__django-11400",
  "edit_test_file": "tests/admin_changelist/tests.py",
  "code_patch": "diff --git a/django/contrib/admin/filters.py b/django/contrib/admin/filters.py\nindex d65e01d..cb530cc 100644\n--- a/django/contrib/admin/filters.py\n+++ b/django/contrib/admin/filters.py\n@@ -419,4 +419,10 @@ FieldListFilter.register(lambda f: True, AllValuesFieldListFilter)\n class RelatedOnlyFieldListFilter(RelatedFieldListFilter):\n     def field_choices(self, field, request, model_admin):\n         pk_qs = model_admin.get_queryset(request).distinct().values_list('%s__pk' % self.field_path, flat=True)\n-        return field.get_choices(include_blank=False, limit_choices_to={'pk__in': pk_qs})\n+        ordering = ()\n+        related_admin = model_admin.admin_site._registry.get(field.remote_field.model)\n+        if related_admin is not None:\n+            ordering = related_admin.get_ordering(request)\n+        if not ordering:\n+            ordering = field.remote_field.model._meta.ordering\n+        return field.get_choices(include_blank=False, limit_choices_to={'pk__in': pk_qs}, ordering=ordering)\n",
  "test_patch": "diff --git a/tests/admin_changelist/test_related_field_list_filter_ordering.py b/tests/admin_changelist/test_related_field_list_filter_ordering.py\nnew file mode 100644\nindex 0000000..bd8b924\n--- /dev/null\n+++ b/tests/admin_changelist/test_related_field_list_filter_ordering.py\n@@ -0,0 +1,58 @@\n+import datetime\n+\n+from django.contrib import admin\n+from django.contrib.admin.views.main import SEARCH_VAR\n+from django.contrib.auth.models import User\n+from django.db import models\n+from django.test import TestCase, override_settings\n+from django.test.client import RequestFactory\n+from django.urls import reverse\n+\n+from .models import Band, Genre\n+from .admin import BandAdmin, site as custom_site\n+\n+\n+@override_settings(ROOT_URLCONF=\"admin_changelist.urls\")\n+class RelatedFieldListFilterOrderingTests(TestCase):\n+    factory = RequestFactory()\n+\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.superuser = User.objects.create_superuser(username='super', email='a@b.com', password='xxx')\n+\n+    def _mocked_authenticated_request(self, url, user):\n+        request = self.factory.get(url)\n+        request.user = user\n+        return request\n+\n+    def test_related_field_list_filter_ordering(self):\n+        \"\"\"\n+        Test to reproduce the issue where RelatedFieldListFilter doesn't fall back\n+        to the ordering defined in Model._meta.ordering.\n+        \"\"\"\n+        # Create genres with specific ordering\n+        genre1 = Genre.objects.create(name='Jazz')\n+        genre2 = Genre.objects.create(name='Blues')\n+        genre3 = Genre.objects.create(name='Rock')\n+\n+        # Create a band and associate genres\n+        band = Band.objects.create(name='The Band', nr_of_members=5)\n+        band.genres.add(genre1, genre2, genre3)\n+\n+        # Set up the BandAdmin with a RelatedFieldListFilter on genres\n+        m = BandAdmin(Band, custom_site)\n+        request = self._mocked_authenticated_request('/band/', self.superuser)\n+        cl = m.get_changelist_instance(request)\n+\n+        # Get the list filter for genres\n+        genre_filter = next(\n+            (f for f in cl.get_filters(request)[0] if f.title == 'genres'),\n+            None\n+        )\n+\n+        # Assert that the ordering is incorrect (empty tuple)\n+        self.assertEqual(genre_filter.lookup_choices, [\n+            (genre1.pk, str(genre1)),\n+            (genre2.pk, str(genre2)),\n+            (genre3.pk, str(genre3)),\n+        ], \"RelatedFieldListFilter did not fall back to Model._meta.ordering\")\n",
  "test_inverted_patch": "diff --git a/tests/admin_changelist/test_related_field_list_filter_ordering_inverted.py b/tests/admin_changelist/test_related_field_list_filter_ordering_inverted.py\nnew file mode 100644\nindex 0000000..9bcb26b\n--- /dev/null\n+++ b/tests/admin_changelist/test_related_field_list_filter_ordering_inverted.py\n@@ -0,0 +1,59 @@\n+import datetime\n+\n+from django.contrib import admin\n+from django.contrib.admin.views.main import SEARCH_VAR\n+from django.contrib.auth.models import User\n+from django.db import models\n+from django.test import TestCase, override_settings\n+from django.test.client import RequestFactory\n+from django.urls import reverse\n+\n+from .models import Band, Genre\n+from .admin import BandAdmin, site as custom_site\n+\n+\n+@override_settings(ROOT_URLCONF=\"admin_changelist.urls\")\n+class RelatedFieldListFilterOrderingTests(TestCase):\n+    factory = RequestFactory()\n+\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.superuser = User.objects.create_superuser(username='super', email='a@b.com', password='xxx')\n+\n+    def _mocked_authenticated_request(self, url, user):\n+        request = self.factory.get(url)\n+        request.user = user\n+        return request\n+\n+    def test_related_field_list_filter_ordering(self):\n+        \"\"\"\n+        Test to reproduce the issue where RelatedFieldListFilter doesn't fall back\n+        to the ordering defined in Model._meta.ordering.\n+        \"\"\"\n+        # Create genres with specific ordering\n+        genre1 = Genre.objects.create(name='Jazz')\n+        genre2 = Genre.objects.create(name='Blues')\n+        genre3 = Genre.objects.create(name='Rock')\n+\n+        # Create a band and associate genres\n+        band = Band.objects.create(name='The Band', nr_of_members=5)\n+        band.genres.add(genre1, genre2, genre3)\n+\n+        # Set up the BandAdmin with a RelatedFieldListFilter on genres\n+        m = BandAdmin(Band, custom_site)\n+        request = self._mocked_authenticated_request('/band/', self.superuser)\n+        cl = m.get_changelist_instance(request)\n+\n+        # Get the list filter for genres\n+        genre_filter = next(\n+            (f for f in cl.get_filters(request)[0] if f.title == 'genres'),\n+            None\n+        )\n+\n+        # Assert that the ordering is incorrect (empty tuple)\n+        # This assertion should now fail when the bug is present\n+        self.assertNotEqual(genre_filter.lookup_choices, [\n+            (genre1.pk, str(genre1)),\n+            (genre2.pk, str(genre2)),\n+            (genre3.pk, str(genre3)),\n+        ], \"__BUG__HERE__\")\n\\ No newline at end of file\n",
  "num_sent_chars": 2135956,
  "num_received_chars": 97927,
  "elapsed_time": 672.4385831356049,
  "lint_repair_count": 5,
  "test_generation_attempts": 7,
  "code_generation_attempts": 9,
  "pass_to_pass": true,
  "pass_to_fail": false,
  "fail_to_pass": false,
  "code_patch_score": 1,
  "appmap_data_test_status": null,
  "appmap_data_file_count": null,
  "appmap_data_context_size": null
}