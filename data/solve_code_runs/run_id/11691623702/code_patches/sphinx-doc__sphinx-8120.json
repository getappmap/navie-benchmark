{
  "instance_id": "sphinx-doc__sphinx-8120",
  "edit_test_file": "tests/test_locale.py",
  "code_patch": "diff --git a/sphinx/locale/__init__.py b/sphinx/locale/__init__.py\nindex 385ca35..9544d61 100644\n--- a/sphinx/locale/__init__.py\n+++ b/sphinx/locale/__init__.py\n@@ -119,7 +119,7 @@ def init(locale_dirs: List[str], language: str,\n     if translator.__class__ is NullTranslations:\n         translator = None\n     # the None entry is the system's default locale path\n-    has_translation = True\n+    has_translation = False\n \n     if language and '_' in language:\n         # for language having country code (like \"de_AT\")\n@@ -127,21 +127,43 @@ def init(locale_dirs: List[str], language: str,\n     else:\n         languages = [language]\n \n-    # loading\n-    for dir_ in locale_dirs:\n+    # First try loading from user-provided locale dirs (excluding None)\n+    user_dirs = [d for d in locale_dirs if d is not None]\n+    builtin_dirs = [d for d in locale_dirs if d is None]\n+\n+    # Try user translations first\n+    for dir_ in user_dirs:\n         try:\n             trans = gettext.translation(catalog, localedir=dir_, languages=languages)\n             if translator is None:\n                 translator = trans\n+                has_translation = True\n+            else:\n+                # Add user translations as primary, not fallback\n+                new_translator = trans\n+                new_translator.add_fallback(translator)\n+                translator = new_translator\n+                has_translation = True\n+        except Exception:\n+            # Language couldn't be found in the specified path\n+            pass\n+\n+    # Then load built-in translations as fallbacks\n+    for dir_ in builtin_dirs:\n+        try:\n+            trans = gettext.translation(catalog, localedir=dir_, languages=languages)\n+            if translator is None:\n+                translator = trans\n+                has_translation = True\n             else:\n                 translator.add_fallback(trans)\n         except Exception:\n             # Language couldn't be found in the specified path\n             pass\n+\n     # guarantee translators[(namespace, catalog)] exists\n     if translator is None:\n         translator = NullTranslations()\n-        has_translation = False\n     translators[(namespace, catalog)] = translator\n     return translator, has_translation\n \n",
  "test_patch": "diff --git a/tests/test_translation_override.py b/tests/test_translation_override.py\nnew file mode 100644\nindex 0000000..b06cbd3\n--- /dev/null\n+++ b/tests/test_translation_override.py\n@@ -0,0 +1,34 @@\n+import os\n+import shutil\n+import unittest\n+from sphinx import locale\n+\n+class TestTranslationOverride(unittest.TestCase):\n+    def setUp(self):\n+        self.rootdir = os.path.abspath(os.path.dirname(__file__))\n+        self.locale_dir = os.path.join(self.rootdir, 'locale', 'da', 'LC_MESSAGES')\n+        os.makedirs(self.locale_dir, exist_ok=True)\n+        self.po_file = os.path.join(self.locale_dir, 'sphinx.po')\n+        self.mo_file = os.path.join(self.locale_dir, 'sphinx.mo')\n+\n+        # Create a dummy .po file\n+        with open(self.po_file, 'w', encoding='utf-8') as f:\n+            f.write('msgid \"Fig. %s\"\\nmsgstr \"Foobar %s\"\\n')\n+            f.write('msgid \"Listing %s\"\\nmsgstr \"Whatever %s\"\\n')\n+\n+        # Simulate the creation of .mo file\n+        shutil.copy(self.po_file, self.mo_file)\n+\n+    def tearDown(self):\n+        shutil.rmtree(os.path.join(self.rootdir, 'locale'))\n+\n+    def test_translation_override(self):\n+        locale.init([self.rootdir], 'da', 'sphinx')\n+        _ = locale.get_translation('sphinx')\n+\n+        # Check if the translations are not used (issue reproduction)\n+        self.assertEqual(_('Fig. %s') % 1, 'Fig. 1')\n+        self.assertEqual(_('Listing %s') % 1, 'Listing 1')\n+\n+if __name__ == '__main__':\n+    unittest.main()\n",
  "test_inverted_patch": "diff --git a/tests/test_translation_override_inverted.py b/tests/test_translation_override_inverted.py\nnew file mode 100644\nindex 0000000..5f3c943\n--- /dev/null\n+++ b/tests/test_translation_override_inverted.py\n@@ -0,0 +1,35 @@\n+import os\n+import shutil\n+import unittest\n+from sphinx import locale\n+\n+class TestTranslationOverride(unittest.TestCase):\n+    def setUp(self):\n+        self.rootdir = os.path.abspath(os.path.dirname(__file__))\n+        self.locale_dir = os.path.join(self.rootdir, 'locale', 'da', 'LC_MESSAGES')\n+        os.makedirs(self.locale_dir, exist_ok=True)\n+        self.po_file = os.path.join(self.locale_dir, 'sphinx.po')\n+        self.mo_file = os.path.join(self.locale_dir, 'sphinx.mo')\n+\n+        # Create a dummy .po file\n+        with open(self.po_file, 'w', encoding='utf-8') as f:\n+            f.write('msgid \"Fig. %s\"\\nmsgstr \"Foobar %s\"\\n')\n+            f.write('msgid \"Listing %s\"\\nmsgstr \"Whatever %s\"\\n')\n+\n+        # Simulate the creation of .mo file\n+        shutil.copy(self.po_file, self.mo_file)\n+\n+    def tearDown(self):\n+        shutil.rmtree(os.path.join(self.rootdir, 'locale'))\n+\n+    def test_translation_override(self):\n+        locale.init([self.rootdir], 'da', 'sphinx')\n+        _ = locale.get_translation('sphinx')\n+\n+        # Check if the translations are used (issue reproduction)\n+        # This should now fail if the bug is present\n+        self.assertEqual(_('Fig. %s') % 1, 'Foobar 1', '__BUG__HERE__')\n+        self.assertEqual(_('Listing %s') % 1, 'Whatever 1', '__BUG__HERE__')\n+\n+if __name__ == '__main__':\n+    unittest.main()\n",
  "num_sent_chars": 3419169,
  "num_received_chars": 60256,
  "elapsed_time": 861.8844976425171,
  "lint_repair_count": 0,
  "test_generation_attempts": 0,
  "code_generation_attempts": 9,
  "pass_to_pass": true,
  "pass_to_fail": false,
  "fail_to_pass": false,
  "code_patch_score": 1,
  "appmap_data_test_status": null,
  "appmap_data_file_count": null,
  "appmap_data_context_size": null
}