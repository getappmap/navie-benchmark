{
  "instance_id": "django__django-14915",
  "edit_test_file": "tests/forms_tests/widget_tests/test_select.py",
  "code_patch": "diff --git a/django/forms/models.py b/django/forms/models.py\nindex 5dcf923..e9641e5 100644\n--- a/django/forms/models.py\n+++ b/django/forms/models.py\n@@ -1158,6 +1158,8 @@ class InlineForeignKeyField(Field):\n         return False\n \n \n+from django.utils.hashable import make_hashable\n+\n class ModelChoiceIteratorValue:\n     def __init__(self, value, instance):\n         self.value = value\n@@ -1171,6 +1173,9 @@ class ModelChoiceIteratorValue:\n             other = other.value\n         return self.value == other\n \n+    def __hash__(self):\n+        return hash(make_hashable(self.value))\n+\n \n class ModelChoiceIterator:\n     def __init__(self, field):\n",
  "test_patch": "diff --git a/tests/forms_tests/widget_tests/test_model_choice_iterator_value.py b/tests/forms_tests/widget_tests/test_model_choice_iterator_value.py\nnew file mode 100644\nindex 0000000..8ca6cf0\n--- /dev/null\n+++ b/tests/forms_tests/widget_tests/test_model_choice_iterator_value.py\n@@ -0,0 +1,41 @@\n+from django.forms import Select\n+from django.forms.models import ModelChoiceIteratorValue\n+from django.test import TestCase\n+import json\n+\n+from .base import WidgetTest\n+\n+\n+class CustomSelectWithDataFields(Select):\n+    def __init__(self, *args, **kwargs):\n+        super().__init__(*args, **kwargs)\n+        # Dictionary mapping values to fields that should be shown\n+        self.show_fields = {\n+            1: ['first_name', 'last_name'],\n+            2: ['email', 'phone']\n+        }\n+\n+    def create_option(self, name, value, label, selected, index, subindex=None, attrs=None):\n+        context = super().create_option(name, value, label, selected, index, subindex, attrs)\n+        if not value:\n+            return context\n+        \n+        # This will raise TypeError because ModelChoiceIteratorValue is not hashable\n+        if value in self.show_fields:\n+            context['attrs']['data-fields'] = json.dumps(self.show_fields[value])\n+        \n+        return context\n+\n+\n+class ModelChoiceIteratorValueHashableTest(WidgetTest):\n+    def test_model_choice_iterator_value_not_hashable(self):\n+        \"\"\"\n+        Test that using ModelChoiceIteratorValue as a dictionary key raises TypeError.\n+        This reproduces the issue where ModelChoiceIteratorValue is not hashable.\n+        \"\"\"\n+        widget = CustomSelectWithDataFields(choices=self.beatles)\n+        value = ModelChoiceIteratorValue(1, \"John\")\n+\n+        with self.assertRaisesMessage(TypeError, \"unhashable type: 'ModelChoiceIteratorValue'\"):\n+            # This should raise TypeError because ModelChoiceIteratorValue cannot be used as dict key\n+            widget.create_option(\"name\", value, \"John\", False, 0)\n\\ No newline at end of file\n",
  "test_inverted_patch": "diff --git a/tests/forms_tests/widget_tests/test_model_choice_iterator_value_inverted.py b/tests/forms_tests/widget_tests/test_model_choice_iterator_value_inverted.py\nnew file mode 100644\nindex 0000000..ec891ce\n--- /dev/null\n+++ b/tests/forms_tests/widget_tests/test_model_choice_iterator_value_inverted.py\n@@ -0,0 +1,41 @@\n+from django.forms import Select\n+from django.forms.models import ModelChoiceIteratorValue\n+from django.test import TestCase\n+import json\n+\n+from .base import WidgetTest\n+\n+\n+class CustomSelectWithDataFields(Select):\n+    def __init__(self, *args, **kwargs):\n+        super().__init__(*args, **kwargs)\n+        self.show_fields = {\n+            1: ['first_name', 'last_name'],\n+            2: ['email', 'phone']\n+        }\n+\n+    def create_option(self, name, value, label, selected, index, subindex=None, attrs=None):\n+        context = super().create_option(name, value, label, selected, index, subindex, attrs)\n+        if not value:\n+            return context\n+        \n+        try:\n+            if value in self.show_fields:\n+                context['attrs']['data-fields'] = json.dumps(self.show_fields[value])\n+        except TypeError:\n+            raise AssertionError(\"__BUG__HERE__\")\n+        \n+        return context\n+\n+\n+class ModelChoiceIteratorValueHashableTest(WidgetTest):\n+    def test_model_choice_iterator_value_not_hashable(self):\n+        \"\"\"\n+        Test that using ModelChoiceIteratorValue as a dictionary key raises an error.\n+        The test should fail when ModelChoiceIteratorValue is not hashable.\n+        \"\"\"\n+        widget = CustomSelectWithDataFields(choices=self.beatles)\n+        value = ModelChoiceIteratorValue(1, \"John\")\n+        \n+        # This should fail with \"__BUG__HERE__\" when ModelChoiceIteratorValue is not hashable\n+        widget.create_option(\"name\", value, \"John\", False, 0)\n\\ No newline at end of file\n",
  "num_sent_chars": 1014016,
  "num_received_chars": 9413,
  "elapsed_time": 130.65091109275818,
  "lint_repair_count": 1,
  "test_generation_attempts": 0,
  "code_generation_attempts": 1,
  "pass_to_pass": true,
  "pass_to_fail": true,
  "fail_to_pass": true,
  "code_patch_score": 3,
  "appmap_data_test_status": null,
  "appmap_data_file_count": null,
  "appmap_data_context_size": null
}