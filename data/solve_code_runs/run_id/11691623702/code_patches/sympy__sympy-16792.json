{
  "instance_id": "sympy__sympy-16792",
  "edit_test_file": "sympy/utilities/tests/test_codegen.py",
  "code_patch": "diff --git a/sympy/utilities/autowrap.py b/sympy/utilities/autowrap.py\nindex bd6afb1..522a2c1 100644\n--- a/sympy/utilities/autowrap.py\n+++ b/sympy/utilities/autowrap.py\n@@ -80,6 +80,7 @@\n from sympy.core.function import Lambda\n from sympy.core.relational import Eq\n from sympy.core.symbol import Dummy, Symbol\n+from sympy.matrices.expressions.matexpr import MatrixSymbol\n from sympy.tensor.indexed import Idx, IndexedBase\n from sympy.utilities.codegen import (make_routine, get_code_generator,\n                                      OutputArgument, InOutArgument,\n@@ -441,9 +442,9 @@ def _prototype_arg(self, arg):\n         np_types = {'double': 'np.double_t',\n                     'int': 'np.int_t'}\n         t = arg.get_datatype('c')\n-        if arg.dimensions:\n+        if arg.dimensions or isinstance(arg.name, MatrixSymbol):\n             self._need_numpy = True\n-            ndim = len(arg.dimensions)\n+            ndim = len(arg.dimensions) if arg.dimensions else len(arg.name.shape)\n             mtype = np_types[t]\n             return mat_dec.format(mtype=mtype, ndim=ndim, name=self._string_var(arg.name))\n         else:\n",
  "test_patch": "diff --git a/sympy/utilities/tests/test_autowrap_array_args.py b/sympy/utilities/tests/test_autowrap_array_args.py\nnew file mode 100644\nindex 0000000..41ea8de\n--- /dev/null\n+++ b/sympy/utilities/tests/test_autowrap_array_args.py\n@@ -0,0 +1,30 @@\n+from sympy.core import symbols\n+from sympy.matrices import MatrixSymbol\n+from sympy.utilities.codegen import codegen\n+from sympy.utilities.pytest import raises\n+\n+def test_codegen_matrix_unused_arg():\n+    \"\"\"Test that codegen handles matrix arguments correctly even when unused in expression\"\"\"\n+    x = MatrixSymbol('x', 2, 1)\n+    expr = 1.0\n+    \n+    # Generate code for the expression with unused matrix argument\n+    name_expr = (\"test\", expr)\n+    result = codegen(name_expr, \"C\", \"file\", header=False, empty=False, argument_sequence=(x,))\n+    \n+    source = result[0][1]\n+    \n+    # The generated code should treat x as a pointer/array argument\n+    # But instead it incorrectly generates it as a scalar\n+    expected_incorrect = (\n+        '#include \"file.h\"\\n'\n+        '#include <math.h>\\n'\n+        'double test(double x) {\\n'\n+        '   double test_result;\\n'\n+        '   test_result = 1.0;\\n'\n+        '   return test_result;\\n'\n+        '}\\n'\n+    )\n+    \n+    # Verify that the incorrect code is generated, demonstrating the issue\n+    assert source == expected_incorrect\n",
  "test_inverted_patch": "diff --git a/sympy/utilities/tests/test_autowrap_array_args_inverted.py b/sympy/utilities/tests/test_autowrap_array_args_inverted.py\nnew file mode 100644\nindex 0000000..dbf9d96\n--- /dev/null\n+++ b/sympy/utilities/tests/test_autowrap_array_args_inverted.py\n@@ -0,0 +1,28 @@\n+from sympy.core import symbols\n+from sympy.matrices import MatrixSymbol\n+from sympy.utilities.codegen import codegen\n+\n+def test_codegen_matrix_unused_arg():\n+    \"\"\"Test that codegen handles matrix arguments correctly when unused in expression\"\"\"\n+    x = MatrixSymbol('x', 2, 1)\n+    expr = 1.0\n+    \n+    # Generate code for the expression with unused matrix argument\n+    name_expr = (\"test\", expr)\n+    result = codegen(name_expr, \"C\", \"file\", header=False, empty=False, argument_sequence=(x,))\n+    \n+    source = result[0][1]\n+    \n+    # The generated code should treat x as a pointer/array argument\n+    expected_correct = (\n+        '#include \"file.h\"\\n'\n+        '#include <math.h>\\n'\n+        'double test(double *x) {\\n'\n+        '   double test_result;\\n'\n+        '   test_result = 1.0;\\n'\n+        '   return test_result;\\n'\n+        '}\\n'\n+    )\n+    \n+    if source != expected_correct:\n+        raise AssertionError(\"__BUG__HERE__\")\n\\ No newline at end of file\n",
  "num_sent_chars": 3897282,
  "num_received_chars": 55470,
  "elapsed_time": 782.3673551082611,
  "lint_repair_count": 2,
  "test_generation_attempts": 0,
  "code_generation_attempts": 9,
  "pass_to_pass": true,
  "pass_to_fail": false,
  "fail_to_pass": false,
  "code_patch_score": 1,
  "appmap_data_test_status": null,
  "appmap_data_file_count": null,
  "appmap_data_context_size": null
}