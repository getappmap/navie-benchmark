{
  "instance_id": "django__django-13786",
  "edit_test_file": "tests/migrations/test_operations.py",
  "code_patch": "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex dddf7c6..1b33f2a 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -137,11 +137,15 @@ class CreateModel(ModelOperation):\n                 ),\n             ]\n         elif isinstance(operation, AlterModelOptions) and self.name_lower == operation.name_lower:\n+            # Remove options not present in operation.options\n+            new_options = {key: value for key, value in self.options.items() if key in operation.options}\n+            # Merge with operation.options\n+            new_options.update(operation.options)\n             return [\n                 CreateModel(\n                     self.name,\n                     fields=self.fields,\n-                    options={**self.options, **operation.options},\n+                    options=new_options,\n                     bases=self.bases,\n                     managers=self.managers,\n                 ),\n",
  "test_patch": "diff --git a/tests/migrations/test_migrations_optimize_options.py b/tests/migrations/test_migrations_optimize_options.py\nnew file mode 100644\nindex 0000000..49b679b\n--- /dev/null\n+++ b/tests/migrations/test_migrations_optimize_options.py\n@@ -0,0 +1,47 @@\n+from django.db import migrations, models\n+from django.test import SimpleTestCase\n+from django.db.migrations.state import ProjectState\n+\n+class TestMigrationsOptimizeOptions(SimpleTestCase):\n+    def test_squashmigrations_does_not_unset_model_options(self):\n+        \"\"\"\n+        Test that squashing migrations does not unset model options when\n+        optimizing CreateModel and AlterModelOptions.\n+        \"\"\"\n+        # Initial state with a model having some options\n+        initial_state = ProjectState()\n+        initial_state.add_model(\n+            migrations.state.ModelState(\n+                app_label='test_app',\n+                name='TestModel',\n+                fields=[\n+                    ('id', models.AutoField(primary_key=True)),\n+                ],\n+                options={'verbose_name': 'Test Model'},\n+            )\n+        )\n+\n+        # CreateModel operation with initial options\n+        create_model_op = migrations.CreateModel(\n+            name='TestModel',\n+            fields=[\n+                ('id', models.AutoField(primary_key=True)),\n+            ],\n+            options={'verbose_name': 'Test Model'},\n+        )\n+\n+        # AlterModelOptions operation that should clear options\n+        alter_model_options_op = migrations.AlterModelOptions(\n+            name='TestModel',\n+            options={},\n+        )\n+\n+        # Simulate the squashing process\n+        reduced_operations = create_model_op.reduce(alter_model_options_op, 'test_app')\n+\n+        # Check that the reduced operation still has the verbose_name option\n+        self.assertEqual(\n+            reduced_operations[0].options.get('verbose_name'),\n+            'Test Model',\n+            \"The verbose_name option should not be present after squashing.\"\n+        )\n\\ No newline at end of file\n",
  "test_inverted_patch": "diff --git a/tests/migrations/test_migrations_optimize_options_inverted.py b/tests/migrations/test_migrations_optimize_options_inverted.py\nnew file mode 100644\nindex 0000000..0698556\n--- /dev/null\n+++ b/tests/migrations/test_migrations_optimize_options_inverted.py\n@@ -0,0 +1,44 @@\n+from django.db import migrations, models\n+from django.test import SimpleTestCase\n+from django.db.migrations.state import ProjectState\n+\n+class TestMigrationsOptimizeOptions(SimpleTestCase):\n+    def test_squashmigrations_does_not_unset_model_options(self):\n+        \"\"\"\n+        Test that squashing migrations does not unset model options when\n+        optimizing CreateModel and AlterModelOptions.\n+        \"\"\"\n+        # Initial state with a model having some options\n+        initial_state = ProjectState()\n+        initial_state.add_model(\n+            migrations.state.ModelState(\n+                app_label='test_app',\n+                name='TestModel',\n+                fields=[\n+                    ('id', models.AutoField(primary_key=True)),\n+                ],\n+                options={'verbose_name': 'Test Model'},\n+            )\n+        )\n+\n+        # CreateModel operation with initial options\n+        create_model_op = migrations.CreateModel(\n+            name='TestModel',\n+            fields=[\n+                ('id', models.AutoField(primary_key=True)),\n+            ],\n+            options={'verbose_name': 'Test Model'},\n+        )\n+\n+        # AlterModelOptions operation that should clear options\n+        alter_model_options_op = migrations.AlterModelOptions(\n+            name='TestModel',\n+            options={},\n+        )\n+\n+        # Simulate the squashing process\n+        reduced_operations = create_model_op.reduce(alter_model_options_op, 'test_app')\n+\n+        # Check that the reduced operation does not have the verbose_name option\n+        if reduced_operations[0].options.get('verbose_name') == 'Test Model':\n+            raise AssertionError(\"__BUG__HERE__\")\n\\ No newline at end of file\n",
  "num_sent_chars": 1168775,
  "num_received_chars": 16222,
  "elapsed_time": 107.5392632484436,
  "lint_repair_count": 2,
  "test_generation_attempts": 2,
  "code_generation_attempts": 1,
  "pass_to_pass": true,
  "pass_to_fail": true,
  "fail_to_pass": true,
  "code_patch_score": 3,
  "appmap_data_test_status": null,
  "appmap_data_file_count": null,
  "appmap_data_context_size": null
}