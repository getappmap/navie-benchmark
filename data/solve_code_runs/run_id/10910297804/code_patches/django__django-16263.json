{
  "instance_id": "django__django-16263",
  "edit_test_file": "tests/aggregation/tests.py",
  "code_patch": "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 9735ce1..580b6e7 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -550,6 +550,18 @@ class Query(BaseExpression):\n         Perform a COUNT() query using the current filter constraints.\n         \"\"\"\n         obj = self.clone()\n+        # Strip annotations that are not used in filters, other annotations, or ordering\n+        if obj.annotation_select:\n+            used_annotations = set()\n+            if obj.where:\n+                used_annotations.update(\n+                    ref for ref in obj._gen_col_aliases(obj.where.children)\n+                )\n+            if obj.order_by:\n+                used_annotations.update(\n+                    ref for ref in obj._gen_col_aliases(obj.order_by)\n+                )\n+            obj.set_annotation_mask(used_annotations)\n         obj.add_annotation(Count(\"*\"), alias=\"__count\", is_summary=True)\n         return obj.get_aggregation(using, [\"__count\"])[\"__count\"]\n \n",
  "test_patch": "diff --git a/tests/aggregation/test_strip_unused_annotations.py b/tests/aggregation/test_strip_unused_annotations.py\nnew file mode 100644\nindex 0000000..ad4d67e\n--- /dev/null\n+++ b/tests/aggregation/test_strip_unused_annotations.py\n@@ -0,0 +1,38 @@\n+import datetime\n+from decimal import Decimal\n+from django.db.models import Count\n+from django.test import TestCase\n+from .models import Author, Book, Publisher, Store\n+\n+class CountAnnotationStripTestCase(TestCase):\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.a1 = Author.objects.create(name=\"Adrian Holovaty\", age=34)\n+        cls.p1 = Publisher.objects.create(name=\"Apress\", num_awards=3)\n+        cls.b1 = Book.objects.create(\n+            isbn=\"159059725\",\n+            name=\"The Definitive Guide to Django: Web Development Done Right\",\n+            pages=447,\n+            rating=4.5,\n+            price=Decimal(\"30.00\"),\n+            contact=cls.a1,\n+            publisher=cls.p1,\n+            pubdate=datetime.date(2007, 12, 6),\n+        )\n+        cls.b2 = Book.objects.create(\n+            isbn=\"067232959\",\n+            name=\"Sams Teach Yourself Django in 24 Hours\",\n+            pages=528,\n+            rating=3.0,\n+            price=Decimal(\"23.09\"),\n+            contact=cls.a1,\n+            publisher=cls.p1,\n+            pubdate=datetime.date(2008, 3, 3),\n+        )\n+\n+    def test_count_with_unused_annotation(self):\n+        # This test reproduces the issue where an unused annotation is not stripped\n+        # from the count query, leading to unnecessary complexity in the SQL.\n+        count_with_annotation = Book.objects.annotate(Count('authors')).count()\n+        count_without_annotation = Book.objects.count()\n+        self.assertEqual(count_with_annotation, count_without_annotation)\n\\ No newline at end of file\n",
  "test_inverted_patch": "diff --git a/tests/aggregation/test_strip_unused_annotations_inverted.py b/tests/aggregation/test_strip_unused_annotations_inverted.py\nnew file mode 100644\nindex 0000000..6cfd768\n--- /dev/null\n+++ b/tests/aggregation/test_strip_unused_annotations_inverted.py\n@@ -0,0 +1,39 @@\n+import datetime\n+from decimal import Decimal\n+from django.db.models import Count\n+from django.test import TestCase\n+from .models import Author, Book, Publisher, Store\n+\n+class CountAnnotationStripTestCase(TestCase):\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.a1 = Author.objects.create(name=\"Adrian Holovaty\", age=34)\n+        cls.p1 = Publisher.objects.create(name=\"Apress\", num_awards=3)\n+        cls.b1 = Book.objects.create(\n+            isbn=\"159059725\",\n+            name=\"The Definitive Guide to Django: Web Development Done Right\",\n+            pages=447,\n+            rating=4.5,\n+            price=Decimal(\"30.00\"),\n+            contact=cls.a1,\n+            publisher=cls.p1,\n+            pubdate=datetime.date(2007, 12, 6),\n+        )\n+        cls.b2 = Book.objects.create(\n+            isbn=\"067232959\",\n+            name=\"Sams Teach Yourself Django in 24 Hours\",\n+            pages=528,\n+            rating=3.0,\n+            price=Decimal(\"23.09\"),\n+            contact=cls.a1,\n+            publisher=cls.p1,\n+            pubdate=datetime.date(2008, 3, 3),\n+        )\n+\n+    def test_count_with_unused_annotation(self):\n+        # This test should fail if the unused annotation is not stripped\n+        # from the count query, indicating the presence of the bug.\n+        count_with_annotation = Book.objects.annotate(Count('authors')).count()\n+        count_without_annotation = Book.objects.count()\n+        if count_with_annotation == count_without_annotation:\n+            raise AssertionError(\"__BUG__HERE__\")\n\\ No newline at end of file\n",
  "num_sent_chars": 1998145,
  "num_received_chars": 109349,
  "elapsed_time": 1090.9405689239502,
  "lint_repair_count": 2,
  "test_generation_attempts": 0,
  "code_generation_attempts": 9,
  "pass_to_pass": true,
  "pass_to_fail": false,
  "fail_to_pass": false,
  "code_patch_score": 1,
  "appmap_data_test_status": null,
  "appmap_data_file_count": null,
  "appmap_data_context_size": null
}