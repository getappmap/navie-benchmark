{
  "instance_id": "psf__requests-1963",
  "edit_test_file": "test_requests.py",
  "code_patch": "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 425db22..15e1de3 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -86,10 +86,10 @@ class SessionRedirectMixin(object):\n         \"\"\"Receives a Response. Returns a generator of Responses.\"\"\"\n \n         i = 0\n+        # Create a copy of the original request that we'll modify for each redirect\n+        prepared_request = req.copy()\n \n         while resp.is_redirect:\n-            prepared_request = req.copy()\n-\n             resp.content  # Consume socket so it can be released\n \n             if i >= self.max_redirects:\n@@ -99,7 +99,7 @@ class SessionRedirectMixin(object):\n             resp.close()\n \n             url = resp.headers['location']\n-            method = req.method\n+            method = prepared_request.method\n \n             # Handle redirection without scheme (see: RFC 1808 Section 4)\n             if url.startswith('//'):\n",
  "code_files": null,
  "test_patch": "diff --git a/test_redirect_method_preservation.py b/test_redirect_method_preservation.py\nnew file mode 100644\nindex 0000000..a72840b\n--- /dev/null\n+++ b/test_redirect_method_preservation.py\n@@ -0,0 +1,43 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+\n+\"\"\"Tests for request method preservation during redirects.\"\"\"\n+\n+import unittest\n+import requests\n+\n+\n+def httpbin(*suffix):\n+    \"\"\"Returns url for HTTPBIN resource.\"\"\"\n+    return '/'.join(['http://httpbin.org'] + list(suffix))\n+\n+\n+class TestRedirectMethodPreservation(unittest.TestCase):\n+\n+    def test_303_307_redirect_chain(self):\n+        \"\"\"Test that a 303 followed by 307 redirect preserves the correct method.\n+        \n+        A POST converted to GET by 303 should remain GET after 307 redirect.\n+        The issue causes the original POST method to be incorrectly restored.\n+        \"\"\"\n+        s = requests.Session()\n+\n+        # Make a POST request that will get redirected with 303 then 307\n+        r = s.post(httpbin('redirect-to'), params={\n+            'url': httpbin('status/307'),\n+            'status_code': 303\n+        })\n+\n+        # Verify the request chain:\n+        # 1. Original POST request\n+        assert r.history[0].request.method == 'POST'\n+        \n+        # 2. After 303, should be converted to GET\n+        assert r.history[1].request.method == 'GET'\n+        \n+        # 3. After 307, should still be GET but the issue causes it to be POST\n+        assert r.request.method == 'POST'\n+\n+\n+if __name__ == '__main__':\n+    unittest.main()\n\\ No newline at end of file\n",
  "test_inverted_patch": "diff --git a/test_redirect_method_preservation_inverted.py b/test_redirect_method_preservation_inverted.py\nnew file mode 100644\nindex 0000000..8422f68\n--- /dev/null\n+++ b/test_redirect_method_preservation_inverted.py\n@@ -0,0 +1,45 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+\n+\"\"\"Tests for request method preservation during redirects.\"\"\"\n+\n+import unittest\n+import requests\n+\n+\n+def httpbin(*suffix):\n+    \"\"\"Returns url for HTTPBIN resource.\"\"\"\n+    return '/'.join(['http://httpbin.org'] + list(suffix))\n+\n+\n+class TestRedirectMethodPreservation(unittest.TestCase):\n+\n+    def test_303_307_redirect_chain(self):\n+        \"\"\"Test that a 303 followed by 307 redirect preserves the correct method.\n+        \n+        A POST converted to GET by 303 should remain GET after 307 redirect.\n+        The issue causes the original POST method to be incorrectly restored.\n+        \"\"\"\n+        s = requests.Session()\n+\n+        # Make a POST request that will get redirected with 303 then 307\n+        r = s.post(httpbin('redirect-to'), params={\n+            'url': httpbin('status/307'),\n+            'status_code': 303\n+        })\n+\n+        # Verify the request chain:\n+        # 1. Original POST request\n+        self.assertEqual(r.history[0].request.method, 'POST')\n+        \n+        # 2. After 303, should be converted to GET\n+        self.assertEqual(r.history[1].request.method, 'GET')\n+        \n+        # 3. After 307, should still be GET but the issue causes it to be POST\n+        if r.request.method == 'POST':\n+            raise AssertionError('__BUG__HERE__')\n+        self.assertEqual(r.request.method, 'GET')\n+\n+\n+if __name__ == '__main__':\n+    unittest.main()\n\\ No newline at end of file\n",
  "num_sent_chars": 5761702,
  "num_received_chars": 99600,
  "elapsed_time": 3289.2013454437256,
  "lint_repair_count": 1,
  "test_generation_attempts": 8,
  "code_generation_attempts": 9,
  "pass_to_pass": false,
  "pass_to_fail": true,
  "fail_to_pass": true,
  "code_patch_score": 2,
  "appmap_data_test_status": null,
  "appmap_data_file_count": null,
  "appmap_data_context_size": null
}