{
  "instance_id": "django__django-17051",
  "edit_test_file": "tests/bulk_create/tests.py",
  "code_patch": "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5ac2407..e3ac711 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -812,7 +812,7 @@ class QuerySet(AltersData):\n                 connection = connections[self.db]\n                 if (\n                     connection.features.can_return_rows_from_bulk_insert\n-                    and on_conflict is None\n+                    and (on_conflict is None or on_conflict == OnConflict.UPDATE)\n                 ):\n                     assert len(returned_columns) == len(objs_without_pk)\n                 for obj_without_pk, results in zip(objs_without_pk, returned_columns):\n@@ -1837,13 +1837,16 @@ class QuerySet(AltersData):\n         inserted_rows = []\n         bulk_return = connection.features.can_return_rows_from_bulk_insert\n         for item in [objs[i : i + batch_size] for i in range(0, len(objs), batch_size)]:\n-            if bulk_return and on_conflict is None:\n+            if bulk_return and (on_conflict is None or on_conflict == OnConflict.UPDATE):\n                 inserted_rows.extend(\n                     self._insert(\n                         item,\n                         fields=fields,\n                         using=self.db,\n                         returning_fields=self.model._meta.db_returning_fields,\n+                        on_conflict=on_conflict,\n+                        update_fields=update_fields,\n+                        unique_fields=unique_fields,\n                     )\n                 )\n             else:\n",
  "code_files": null,
  "test_patch": "diff --git a/tests/bulk_create/test_bulk_create_update_conflicts_ids.py b/tests/bulk_create/test_bulk_create_update_conflicts_ids.py\nnew file mode 100644\nindex 0000000..ae82255\n--- /dev/null\n+++ b/tests/bulk_create/test_bulk_create_update_conflicts_ids.py\n@@ -0,0 +1,41 @@\n+from django.test import TestCase, skipUnlessDBFeature\n+\n+from .models import TwoFields\n+\n+\n+@skipUnlessDBFeature(\"supports_update_conflicts\", \"supports_update_conflicts_with_target\")\n+class BulkCreateUpdateConflictsIdsTests(TestCase):\n+    def test_bulk_create_update_conflicts_returns_no_ids(self):\n+        \"\"\"\n+        bulk_create() with update_conflicts=True does not set primary keys on the\n+        returned objects, even though the database could return them.\n+        \"\"\"\n+        # Create initial objects\n+        TwoFields.objects.bulk_create([\n+            TwoFields(f1=1, f2=1),\n+            TwoFields(f1=2, f2=2),\n+        ])\n+\n+        # Try to create objects that conflict with existing ones\n+        conflicting_objects = [\n+            TwoFields(f1=1, f2=10),  # Will conflict and update\n+            TwoFields(f1=2, f2=20),  # Will conflict and update\n+            TwoFields(f1=3, f2=30),  # New object\n+        ]\n+\n+        objects = TwoFields.objects.bulk_create(\n+            conflicting_objects,\n+            update_conflicts=True,\n+            update_fields=['f2'],\n+            unique_fields=['f1'],\n+        )\n+\n+        # The objects were created/updated successfully\n+        self.assertEqual(TwoFields.objects.count(), 3)\n+        self.assertEqual(\n+            list(TwoFields.objects.order_by('f1').values_list('f1', 'f2')),\n+            [(1, 10), (2, 20), (3, 30)]\n+        )\n+\n+        # But the returned objects don't have their primary keys set\n+        self.assertTrue(all(obj.pk is None for obj in objects))\n\\ No newline at end of file\n",
  "test_inverted_patch": "diff --git a/tests/bulk_create/test_bulk_create_update_conflicts_ids_inverted.py b/tests/bulk_create/test_bulk_create_update_conflicts_ids_inverted.py\nnew file mode 100644\nindex 0000000..8bc4915\n--- /dev/null\n+++ b/tests/bulk_create/test_bulk_create_update_conflicts_ids_inverted.py\n@@ -0,0 +1,47 @@\n+from django.test import TestCase, skipUnlessDBFeature\n+from .models import TwoFields\n+\n+\n+@skipUnlessDBFeature(\"supports_update_conflicts\", \"supports_update_conflicts_with_target\")\n+class BulkCreateUpdateConflictsIdsTests(TestCase):\n+    def test_bulk_create_update_conflicts_should_return_ids(self):\n+        \"\"\"\n+        bulk_create() with update_conflicts=True should set primary keys on the\n+        returned objects when the database can return them.\n+        \"\"\"\n+        # Create initial objects\n+        initial_objects = TwoFields.objects.bulk_create([\n+            TwoFields(f1=1, f2=1),\n+            TwoFields(f1=2, f2=2),\n+        ])\n+\n+        # Try to create objects that conflict with existing ones\n+        conflicting_objects = [\n+            TwoFields(f1=1, f2=10),  # Will conflict and update\n+            TwoFields(f1=2, f2=20),  # Will conflict and update\n+            TwoFields(f1=3, f2=30),  # New object\n+        ]\n+\n+        objects = TwoFields.objects.bulk_create(\n+            conflicting_objects,\n+            update_conflicts=True,\n+            update_fields=['f2'],\n+            unique_fields=['f1'],\n+        )\n+\n+        # Verify the objects were created/updated successfully\n+        self.assertEqual(TwoFields.objects.count(), 3)\n+        self.assertEqual(\n+            list(TwoFields.objects.order_by('f1').values_list('f1', 'f2')),\n+            [(1, 10), (2, 20), (3, 30)]\n+        )\n+\n+        # The returned objects should have their primary keys set\n+        # This will fail with \"__BUG__HERE__\" when the bug is present\n+        if any(obj.pk is None for obj in objects):\n+            raise AssertionError(\"__BUG__HERE__\")\n+\n+        # Additional verification that the PKs are correct\n+        db_objects = list(TwoFields.objects.order_by('f1'))\n+        for returned_obj, db_obj in zip(objects, db_objects):\n+            self.assertEqual(returned_obj.pk, db_obj.pk)\n\\ No newline at end of file\n",
  "num_sent_chars": 1278205,
  "num_received_chars": 17216,
  "elapsed_time": 218.5980830192566,
  "lint_repair_count": 0,
  "test_generation_attempts": 1,
  "code_generation_attempts": 1,
  "pass_to_pass": true,
  "pass_to_fail": true,
  "fail_to_pass": true,
  "code_patch_score": 3,
  "appmap_data_test_status": null,
  "appmap_data_file_count": null,
  "appmap_data_context_size": null
}