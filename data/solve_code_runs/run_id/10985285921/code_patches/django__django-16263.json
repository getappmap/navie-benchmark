{
  "instance_id": "django__django-16263",
  "edit_test_file": "tests/aggregation/tests.py",
  "code_patch": "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 9735ce1..c45cd1c 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -550,6 +550,18 @@ class Query(BaseExpression):\n         Perform a COUNT() query using the current filter constraints.\n         \"\"\"\n         obj = self.clone()\n+        # Strip annotations that are not used in filters, orderings, or other annotations\n+        if obj.annotation_select:\n+            used_annotations = set()\n+            # Collect annotations used in filters\n+            used_annotations.update(self.where.get_source_expressions())\n+            # Collect annotations used in orderings\n+            used_annotations.update(self.order_by)\n+            # Collect annotations used in other annotations\n+            for annotation in obj.annotations.values():\n+                used_annotations.update(annotation.get_source_expressions())\n+            # Set annotation mask to only include used annotations\n+            obj.set_annotation_mask(used_annotations.intersection(obj.annotations.keys()))\n         obj.add_annotation(Count(\"*\"), alias=\"__count\", is_summary=True)\n         return obj.get_aggregation(using, [\"__count\"])[\"__count\"]\n \n",
  "test_patch": "diff --git a/tests/aggregation/test_strip_unused_annotations_from_count_queries.py b/tests/aggregation/test_strip_unused_annotations_from_count_queries.py\nnew file mode 100644\nindex 0000000..fef4790\n--- /dev/null\n+++ b/tests/aggregation/test_strip_unused_annotations_from_count_queries.py\n@@ -0,0 +1,32 @@\n+import datetime\n+from decimal import Decimal\n+from django.db.models import Count\n+from django.test import TestCase\n+from .models import Author, Book, Publisher, Store\n+\n+class StripUnusedAnnotationsTestCase(TestCase):\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.a1 = Author.objects.create(name=\"Adrian Holovaty\", age=34)\n+        cls.p1 = Publisher.objects.create(name=\"Apress\", num_awards=3)\n+        cls.b1 = Book.objects.create(\n+            isbn=\"159059725\",\n+            name=\"The Definitive Guide to Django: Web Development Done Right\",\n+            pages=447,\n+            rating=4.5,\n+            price=Decimal(\"30.00\"),\n+            contact=cls.a1,\n+            publisher=cls.p1,\n+            pubdate=datetime.date(2007, 12, 6),\n+        )\n+        cls.b1.authors.add(cls.a1)\n+\n+    def test_strip_unused_annotations_from_count_queries(self):\n+        # This test reproduces the issue where unused annotations are not stripped\n+        # from count queries, resulting in unnecessary SQL complexity.\n+        with self.assertNumQueries(1) as ctx:\n+            Book.objects.annotate(Count('authors')).count()\n+        sql = ctx.captured_queries[0][\"sql\"]\n+        # Assert that the SQL query includes the Count('authors') annotation\n+        # even though it is not used in any filter operations.\n+        self.assertIn(\"COUNT(\", sql)\n",
  "test_inverted_patch": "diff --git a/tests/aggregation/test_strip_unused_annotations_from_count_queries_inverted.py b/tests/aggregation/test_strip_unused_annotations_from_count_queries_inverted.py\nnew file mode 100644\nindex 0000000..6024df1\n--- /dev/null\n+++ b/tests/aggregation/test_strip_unused_annotations_from_count_queries_inverted.py\n@@ -0,0 +1,33 @@\n+import datetime\n+from decimal import Decimal\n+from django.db.models import Count\n+from django.test import TestCase\n+from .models import Author, Book, Publisher, Store\n+\n+class StripUnusedAnnotationsTestCase(TestCase):\n+    @classmethod\n+    def setUpTestData(cls):\n+        cls.a1 = Author.objects.create(name=\"Adrian Holovaty\", age=34)\n+        cls.p1 = Publisher.objects.create(name=\"Apress\", num_awards=3)\n+        cls.b1 = Book.objects.create(\n+            isbn=\"159059725\",\n+            name=\"The Definitive Guide to Django: Web Development Done Right\",\n+            pages=447,\n+            rating=4.5,\n+            price=Decimal(\"30.00\"),\n+            contact=cls.a1,\n+            publisher=cls.p1,\n+            pubdate=datetime.date(2007, 12, 6),\n+        )\n+        cls.b1.authors.add(cls.a1)\n+\n+    def test_strip_unused_annotations_from_count_queries(self):\n+        # This test should fail if the issue is observed, i.e., if unused annotations are not stripped\n+        # from count queries, resulting in unnecessary SQL complexity.\n+        with self.assertNumQueries(1) as ctx:\n+            Book.objects.annotate(Count('authors')).count()\n+        sql = ctx.captured_queries[0][\"sql\"]\n+        # The test should fail if the SQL query includes the Count('authors') annotation\n+        # even though it is not used in any filter operations.\n+        if \"COUNT(\" in sql:\n+            raise AssertionError(\"__BUG__HERE__\")\n",
  "num_sent_chars": 3076166,
  "num_received_chars": 36833,
  "elapsed_time": 261.9457268714905,
  "lint_repair_count": 0,
  "test_generation_attempts": 0,
  "code_generation_attempts": 9,
  "pass_to_pass": true,
  "pass_to_fail": false,
  "fail_to_pass": false,
  "code_patch_score": 1,
  "appmap_data_test_status": null,
  "appmap_data_file_count": null,
  "appmap_data_context_size": null
}